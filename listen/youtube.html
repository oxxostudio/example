<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="oxxo.studio" />
    <meta name="copyright" content="oxxo.studio" />
    <title>英聽練習</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        font-size: 16px;
      }
      body {
        padding: 10px;
      }
      body * {
        position: relative;
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        font-size: 1rem;
        line-height: 1.5;
      }
      button {
        outline: none;
        border: 1px solid #aaa;
        border-radius: 3px;
        padding: 5px 10px;
        background:#eee;
      }
      button:focus{
        background:#ddd;
      }
      #urlInput{
        display:block;
        width:100%;
        outline: none;
        border:1px solid #aaa;
        margin:10px 0;
        border-radius: 5px;;
        padding:5px;
      }
      #urlInput:focus{
        border:1px solid #000;
      }
      .outside {
        display: inline-block;
        width: calc(50% - 20px);
        height: calc(100% - 20px);
        min-width: 400px;
        vertical-align: top;
      }
      .show {
        margin-left: 10px;
        padding: 10px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }
      .show span {
        cursor: pointer;
        padding: 0 10px;
      }
      .show span:hover {
        background: #eee;
      }
      .show span.read {
        color: #f00;
        background: #fdd;
      }
      .show span.read:hover {
        background: #fdd;
      }
    </style>
  </head>
  <body>
    <div class="outside">
      <div id="player"></div>
      <button id="playBtn">Play</button>
      <button id="pauseBtn">Pause</button>
      <button id="stopBtn">Stop</button>
    </div>
    <div class="outside show"></div>
  </body>
  <script>
    const hash = location.hash.replace('#','');
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const show = document.querySelector(".show");

    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player("player", {
        height: "390",
        width: "100%",
        videoId: hash
      });
    }

    let sec = 0;
    let content = "";
    let vt;
    playBtn.addEventListener("click", videoPlay);

    function videoPlay(){
      clearInterval(vt);
      vt = setInterval(() => {
        sec = ~~player.getCurrentTime();
        if (document.querySelector(`.s${sec}`)) {
          if (document.querySelector(`.read`)) {
            document.querySelector(`.read`).classList.remove("read");
          }
          document.querySelector(`.s${sec}`).classList.add("read");
        }
      }, 1000);
      player.playVideo();
    }

    pauseBtn.addEventListener("click", () => {
      clearInterval(vt);
      player.pauseVideo();
    });

    stopBtn.addEventListener("click", () => {
      clearInterval(vt);
      sec = 0;
      player.stopVideo(1);
    });

    let obj = {};
    fetch(`subtitle/${hash}.srt`)
      .then((res) => {
        return res.text();
      })
      .then((result) => {
        let source = result.split(/\n/);
        source.forEach((e, i) => {
          if (e.indexOf("-->") != -1) {
            let sa = e.split(",")[0].split(":");
            let start = 0;
            start = sa[0] * 3600 + sa[1] * 60 + sa[2] * 1;
            let ea = e.split("--> ")[1].split(",")[0].split(":");
            obj[start] = source[i + 1];
            content = `${content}<span class="s${start}" time="${start}">${source[i + 1]}</span><br/>`;
          }
        });
        show.innerHTML = content;
        document.querySelectorAll(".show span").forEach((e) => {
          e.addEventListener("click", () => {
            videoPlay();
            if (document.querySelector(`.read`)) {
              document.querySelector(`.read`).classList.remove("read");
            }
            e.classList.add("read");
            let t = e.getAttribute("time");
            player.seekTo(t);
          });
        });
      });
  </script>
</html>
