<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>上下班刷卡</title>
  <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
  <style>
  input {
    margin: 3px 0;
  }
  
  select {
    margin-right: 10px;
  }
  
  h2 {
    font-size: 18px;
    margin: 10px;
  }
  
  #showContent {
    line-height: 24px;
  }
  
  #show {
    margin: 10px;
    font-size: 14px;
  }
  
  #show div {
    color: #000;
    margin: 0;
    padding: 0;
    height: 28px;
  }
  
  #show div.today {
    color: #f50;
  }
  
  #show div.today strong,
  #show div.today span {
    background: #fed;
  }
  
  #show div.feature {
    color: #ccc;
  }
  
  #show strong,
  #show span {
    display: inline-block;
    border-width: 1px 1px 0 1px;
    border-style: solid;
    border-color: #aaa;
    padding: 0 5px;
    margin: 0 -1px 0 0;
    line-height: 28px;
    height: 100%;
    width: 90px;
    text-align: center;
  }

  #show strong{
    width: 60px;
  }
  
  #show .tableTitle strong,
  #show .tableTitle span {
    background: #ddd;
  }
  
  #show div:last-child strong,
  #show div:last-child span {
    border-width: 1px;
  }
  </style>
</head>

<body>
  <span>姓名</span>
  <select id="userName" type="text">
    <option value="Marty">益祥 Marty</option>
    <option value="Lynn">玉玲 Lynn</option>
    <option value="Mingze">名澤 Mingze</option>
    <option value="oxxo">宗彥 oxxo</option>
    <option value="Sheng">聖原 Sheng</option>
    <option value="Enya">宛儀 Enya</option>
    <option value="Birte">豪萱 Birte</option>
    <option value="Didi">怡萱 Didi</option>
    <option value="Yuan">阿源 Yuan</option>
  </select>
  <span>月份</span>
  <input id="userDate" type="month">
  <button id="submit">查詢</button>
  <h2><span id="showName">...</span> 在 <span id="showMonth">...</span> 的出勤狀況</h2>
  <div id="show">
  </div>
  <script>
  var firebaseUrl = 'https://bell-card.firebaseio.com/';
  var userName = document.getElementById('userName');
  var userSelect = document.getElementById('userSelect');
  var userDate = document.getElementById('userDate');
  var showName = document.getElementById('showName');
  var showMonth = document.getElementById('showMonth');
  var submit = document.getElementById('submit');
  var show = document.getElementById('show');


  function get_time(t) {
    var varDay = new Date(),
      varYear = varDay.getFullYear(),
      varMonth = varDay.getMonth() + 1,
      varDate = varDay.getDate();

    if (varMonth * 1 < 10) {
      varMonth = '0' + varMonth;
    }

    if (varDate * 1 < 10) {
      varDate = '0' + varDate;
    }

    if (t == 1) {
      return varYear + '-' + varMonth;
    } else if (t == 2) {
      return (varYear + '' + varMonth + '' + varDate) * 1;
    } else {
      return varDate * 1;
    }
  }

  userDate.value = get_time(1);  //設定預設年月份

  submit.addEventListener("click", function() {
    readDate(userDate.value);  
  });

  function readDate(t) {
    var queryTime = t.replace(/-/ig, '');   //轉換日期中間不要有-號
    var dataBaseUrl = firebaseUrl + userName.value;
    var userFirebase = new Firebase(dataBaseUrl);
    var month = [];
    for (var i = 0; i < 31; i++) {
      month[i] = '&nbsp;';   //先做一個長度為31的月份陣列，預設塞入空白字元
    }
    userFirebase.on("value", function(snapshot) {
      showName.innerHTML = userName.value;         //firebase載入後才顯示人名與月份
      showMonth.innerHTML = userDate.value;
      var val = [];
      var date = get_time(2);
      var check, week, d1, d2, kk, mm, yy;
      var m1 = [1, 3, 5, 7, 8, 10, 12];      //判斷大月小月和星期
      var m2 = [4, 6, 9, 11];
      var d3 = ['日', '一', '二', '三', '四', '五', '六'];
      snapshot.forEach(function(data) {
        val.push([data.key(), data.val()]);
      });
      for (var j = 0; j < val.length; j++) {
        var a = val[j][0].substr(0, 6);
        var b = val[j][0].substr(6, 8) * 1 - 1;
        var c = val[j][1];
        if (a == queryTime) {
          month[b] = c;    //把對應日期資料庫的內容，塞到該月份對應的天數裡
        }
      }
      yy = queryTime.substr(0, 4) * 1;
      mm = queryTime.substr(4, 6) * 1;
      if (m1.indexOf(mm) != -1) {
        kk = 31;
      }
      if (m2.indexOf(mm) != -1) {
        kk = 30;
      }
      if (mm == 2 && yy % 4 == 0) {
        kk = 29;    //判斷閏月
      }
      if (mm == 2 && yy % 4 != 0) {
        kk = 28;
      }

      //第一行title
      show.innerHTML = '<div class="tableTitle"><strong>日期</strong><span>首刷</span><span>末刷</span><span>工時</span></div>';

      for (var k = 0; k < kk; k++) {
        if (k < 9) {
          check = (queryTime + '0' + (k + 1)) * 1;  //補零
          week = queryTime.substr(0, 4) + '/' + queryTime.substr(4, 6) + '/' + '0' + (k + 1);
        } else {
          check = (queryTime + '' + (k + 1)) * 1;
          week = queryTime.substr(0, 4) + '/' + queryTime.substr(4, 6) + '/' + (k + 1);
        }
        d1 = new Date(week);
        d2 = d1.getDay();  //判斷星期幾
        //判斷當天有沒有刷卡數值，有的話就會有物件
        if (typeof(month[k]) == 'object') {
          var obj = month[k];
          var arr = Object.keys(obj).map(function(key) {
            return obj[key];
          });
          var tStart, tEnd, tCount;  //設定首刷、末刷與總工時
          var t1 = arr[0].time.split(':');
          var t2 = arr[arr.length - 1].time.split(':');
          if (t1[0] == t2[0] && t1[1] == t2[1]) {
            tStart = arr[0].time;   //如果只有刷一次，或是兩次間隔一分鐘以內，判斷只有首刷
            tEnd = '&nbsp;';
            tCount = '&nbsp;';
          } else {
            tStart = arr[0].time;
            tEnd = arr[arr.length - 1].time;
            var h = t2[0] - t1[0];
            var m = t2[1] - t1[1];
            if (m < 0) {
              m = 60 + m;
              h = h - 1;
            }
            tCount = h + '小時 ' + m + '分';  //計算總工時
          }
          if (check == date) {
            show.innerHTML = show.innerHTML + '<div class="today"><strong>' + (k + 1) + ' (' + d3[d2] + ')</strong><span>' + tStart + '</span><span>' + tEnd + '</span><span>' + tCount + '</span></div>';
          } else {
            show.innerHTML = show.innerHTML + '<div><strong>' + (k + 1) + ' (' + d3[d2] + ')</strong><span>' + tStart + '</span><span>' + tEnd + '</span><span>' + tCount + '</span></div>';
          }
        } else {
          if (check == date) {
            show.innerHTML = show.innerHTML + '<div class="today"><strong>' + (k + 1) + ' (' + d3[d2] + ')</strong><span>' + month[k] + '</span><span>&nbsp;</span><span>&nbsp;</span></div>';
          } else if (check < date) {
            show.innerHTML = show.innerHTML + '<div><strong>' + (k + 1) + ' (' + d3[d2] + ')</strong><span>' + month[k] + '</span><span>&nbsp;</span><span>&nbsp;</span></div>';
          } else {
            show.innerHTML = show.innerHTML + '<div class="feature"><strong>' + (k + 1) + ' (' + d3[d2] + ')</strong><span>' + month[k] + '</span><span>&nbsp;</span><span>&nbsp;</span></div>';
          }
        }
      }
    }, function(errorObject) {
      console.log("The read failed: " + errorObject.code);
    });

  }
  </script>
</body>

</html>
