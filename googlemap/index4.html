<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>google map dht</title>
  <script src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
  <script src="https://blockly.webduino.io/webduino-blockly.js"></script>
  <style>
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  
  #map {
    width: 100%;
    height: 100%;
  }
  
  .mapMarker {
    line-height: 20px;
  }
  
  .mapMarker h3 {
    margin: 5px 0 8px 0;
    padding: 5px 0 8px 0;
    border-bottom: 1px solid #ccc;
  }
  </style>
</head>

<body>
  <div id="map"></div>
  <script type="text/javascript">
  
  var gmapKey = 'AIzaSyB6TBwRrd2pQeyD0COblf4uADkO1EMjSCw';
  var gmapCenter = '二聖公園';
  var gmapZoom = 16;
  var gmapZIndex = 1;
  var gmap;
  var gmapPosArray = [];
  var gmapMarkerArray = [];

  function loadScript(url, callback) {

    var script = document.createElement('script')
    script.type = 'text/javascript';

    script.onload = function() {
      callback();
    };

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  loadScript('https://maps.googleapis.com/maps/api/js?key=' + gmapKey, gmapFn);

  function gmapFn() {

    initialize();

    function initialize() {
      gmap = new google.maps.Map(document.getElementById('map'), {
        zoom: gmapZoom
      });
      setCenter(gmapCenter);
    }

    function setCenter(address) {
      var marker = new google.maps.Marker({
        map: gmap
      });
      geocoder = new google.maps.Geocoder();
      geocoder.geocode({
        address: address
      }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          LatLng = results[0].geometry.location;
          gmap.setCenter(LatLng);
        }
      });
    }

    function addressMarker(address, title, markerID, icon) {
      if (gmapPosArray.indexOf(markerID) == -1) {
        
        gmapPosArray.push(markerID);

        gmapZIndex = gmapZIndex + 1;

        if (icon) {
          var marker = new google.maps.Marker({
            map: gmap,
            zIndex: gmapZIndex,
            icon: icon
          });
        } else {
          var marker = new google.maps.Marker({
            map: gmap,
            zIndex: gmapZIndex
          });
        }

        gmapMarkerArray.push(marker);

        geocoder = new google.maps.Geocoder();
        geocoder.geocode({
          address: address
        }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            LatLng = results[0].geometry.location;
            marker.setPosition(LatLng);
            console.log('lat:' + LatLng.lat() + ',lng:' + LatLng.lng());

            var infowindow = new google.maps.InfoWindow({
              content: '<div id="' + markerID + '" class="mapMarker" style="z-index:' + gmapZIndex + ';"><h3>' + title + '</h3><div class="markerContent"></div></div>'
            });

            infowindow.open(gmap, marker);
            marker.addListener('click', function() {
              infowindow.open(gmap, marker);
            });

          }
        });
      }
    }

    addressMarker('二聖公園', '二聖公園', 'a1');
    addressMarker('英明國中', '英明國中', 'a2', 'http://icons.iconarchive.com/icons/pino/south-park/32/Eric-Cartman-icon.png');
    addressMarker('英明公園', '英明公園', 'a3', 'http://besticons.net/sites/default/files/pizza-icon-9006.png');

  }
  </script>
</body>

</html>
